// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client"
    output   = "../lib/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum Role {
    USER
    ADMIN
}

model User {
    id            String    @id @default(cuid())
    name          String
    email         String    @unique
    emailVerified DateTime?
    username      String?   @unique
    image         String?
    role          Role      @default(USER)

    createdProducts Product[] // Things user sell
    purchases       Purchase[] // Things user bought
    cart            Cart?

    CreatedAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    accounts      Account[]
    sessions      Session[]
    purchaseItems PurchaseItem[]
}

// for OAuth providers
model Account {
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@id([provider, providerAccountId])
}

// for auth session
model Session {
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// verification tokens
model VerificationToken {
    identifier String
    token      String
    expires    DateTime

    @@id([identifier, token])
}

model Product {
    id          String  @id @default(cuid())
    sellerId    String
    title       String
    description String  @db.Text
    price       Float
    isPublished Boolean @default(false)

    // category of item
    category String

    // Public visual assets (Cover images, screenshots)
    images String[]

    // The actual protected file to download
    fileAsset FileAsset?

    seller        User           @relation(fields: [sellerId], references: [id])
    cartItems     CartItem[]
    purchaseItems PurchaseItem[]
}

// the Secure File (Hidden from public)
model FileAsset {
    id         String @id @default(cuid())
    productId  String @unique
    fileName   String // "ui-kit-v2.zip"
    fileSize   Int // In bytes (for showing "250MB")
    storageKey String // The hidden ID in AWS S3 / Cloudflare R2

    product Product @relation(fields: [productId], references: [id])
}

// The Transaction (Proof of ownership)
model Purchase {
    id      String @id @default(cuid())
    buyerId String
    buyer   User   @relation(fields: [buyerId], references: [id])

    totalAmount Float
    createdAt   DateTime @default(now())

    items PurchaseItem[]
}

model PurchaseItem {
    id         String   @id @default(cuid())
    purchaseId String
    purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

    productId String
    product   Product @relation(fields: [productId], references: [id])

    sellerId String
    seller   User   @relation(fields: [sellerId], references: [id])

    price Float

    @@unique([purchaseId, productId])
}

// The cart database for each user
model Cart {
    id       String     @id @default(cuid())
    userId   String?    @unique
    items    CartItem[]
    updateAt DateTime   @updatedAt
    user     User?      @relation(fields: [userId], references: [id])
}

// Items in one's cart
model CartItem {
    id        String  @id @default(cuid())
    cartId    String
    productId String
    cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
    product   Product @relation(fields: [productId], references: [id])
}

// model Product{
// 	id			String @id @default(cuid())
// 	title		String
// 	description	String
// 	price 		Int
// 	imageUrl	String
// 	category	String

// 	createdAt	DateTime @default(now())
// }
